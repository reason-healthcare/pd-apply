{
	"info": {
		"_postman_id": "e340d498-7d23-4d7a-a210-aade83ff4a46",
		"name": "CPG Unit Tests - Plan Definition with Questionnaire",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "25403373"
	},
	"item": [
		{
			"name": "Scenario1 - RA Monitoring Recommendation",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const expected = {",
							"  \"resourceType\": \"Bundle\",",
							"  \"id\": \"RaMonitoringRecommendationExpected1\",",
							"  \"type\": \"collection\",",
							"  \"entry\": [",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/RequestGroup/RaMonitoringRecommendationRequestGroup1\",",
							"      \"resource\": {",
							"        \"resourceType\": \"RequestGroup\",",
							"        \"id\": \"RaMonitoringRecommendationRequestGroup1\",",
							"        \"intent\": \"proposal\",",
							"        \"status\": \"draft\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"instantiatesCanonical\": [",
							"          \"http://example.org/PlanDefinition/RaMonitoringRecommendation\"",
							"        ],",
							"        \"action\": [",
							"          {",
							"            \"title\": \"Order monitoring tests for antirheumatic drug therapy.\",",
							"            \"description\": \"Order monitoring tests for antirheumatic drug therapy.\",",
							"            \"code\": [",
							"              {",
							"                \"coding\": [",
							"                  {",
							"                    \"code\": \"diagnostic-testing\",",
							"                    \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"type\": {",
							"              \"coding\": [",
							"                {",
							"                  \"code\": \"create\",",
							"                  \"system\": \"http://terminology.hl7.org/CodeSystem/action-type\"",
							"                }",
							"              ]",
							"            },",
							"            \"condition\": [",
							"              {",
							"                \"kind\": \"applicability\",",
							"                \"expression\": {",
							"                  \"language\": \"text/cql-identifier\",",
							"                  \"expression\": \"Order monitoring tests if on RA treatment\"",
							"                }",
							"              }",
							"            ],",
							"            \"resource\": {",
							"              \"reference\": \"ServiceRequest/OrderTestingRequest1\"",
							"            }",
							"          }",
							"        ]",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/ServiceRequest/OrderTestingRequest1\",",
							"      \"resource\": {",
							"        \"resourceType\": \"ServiceRequest\",",
							"        \"id\": \"OrderTestingRequest1\",",
							"        \"meta\": {",
							"          \"profile\": [",
							"            \"http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-servicerequest\"",
							"          ]",
							"        },",
							"        \"status\": \"draft\",",
							"        \"doNotPerform\": false,",
							"        \"intent\": \"proposal\",",
							"        \"instantiatesCanonical\": [",
							"          \"http://example.org/ActivityDefinition/OrderServiceActivity\"",
							"        ],",
							"        \"code\": {",
							"          \"coding\": [",
							"            {",
							"              \"code\": \"order-service\",",
							"              \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-activity-type-cs\",",
							"              \"display\": \"Order a service\"",
							"            }",
							"          ]",
							"        },",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"encounter\": {",
							"          \"reference\": \"Encounter/Encounter1\"",
							"        },",
							"        \"requester\": {",
							"          \"reference\": \"Practitioner/Practitioner1\"",
							"        }",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/QuestionnaireResponse/OrderTestingRequest1\",",
							"      \"resource\": {",
							"        \"resourceType\": \"QuestionnaireResponse\",",
							"        \"id\": \"RaQuestionnaireResponse1\",",
							"        \"questionnaire\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire1\",",
							"        \"status\": \"completed\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"authored\": \"2023-12-06T11:45:33+11:00\",",
							"        \"author\": {",
							"          \"reference\": \"Practitioner/Practitioner1\"",
							"        },",
							"        \"item\": [",
							"          {",
							"            \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"            \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"            \"text\": \"Measurements and simple assertions\",",
							"            \"item\": [",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"text\": \"Actual result\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueBoolean\": true",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                \"text\": \"registered | preliminary | final | amended +\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"final\",",
							"                      \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                    }",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                \"text\": \"Type of observation (code / type)\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"on-ra-treatment\",",
							"                      \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                    }",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ],",
							"        \"contained\": [",
							"          {",
							"            \"resourceType\": \"Questionnaire\",",
							"            \"id\": \"RaQuestionnaire1\",",
							"            \"item\": [",
							"              {",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-itemPopulationContext\",",
							"                    \"valueExpression\": {",
							"                      \"language\": \"text/cql-identifier\",",
							"                      \"expression\": \"On RA Treatment\",",
							"                      \"reference\": \"http://example.org/Library/ActiveRaTreatmentFeatureLogic\",",
							"                      \"name\": \"ActiveRaTreatmentFeature\"",
							"                    }",
							"                  }",
							"                ],",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"                \"text\": \"Measurements and simple assertions\",",
							"                \"type\": \"group\",",
							"                \"item\": [",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"registered | preliminary | final | amended +\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"final\",",
							"                          \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"Type of observation (code / type)\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"on-ra-treatment\",",
							"                          \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"text\": \"Actual result\",",
							"                    \"type\": \"boolean\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\",",
							"                        \"valueExpression\": {",
							"                          \"language\": \"text/cql-expression\",",
							"                          \"expression\": \"%ActiveRaTreatmentFeature.value[x]\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"url\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire1\",",
							"            \"status\": \"draft\",",
							"            \"extension\": [",
							"              {",
							"                \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext\",",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"name\",",
							"                    \"valueCoding\": {",
							"                      \"code\": \"patient\",",
							"                      \"system\": \"http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext\"",
							"                    }",
							"                  },",
							"                  {",
							"                    \"url\": \"type\",",
							"                    \"valueCode\": \"Patient\"",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ]",
							"      }",
							"    }",
							"  ]",
							"}",
							"",
							"",
							"",
							"",
							"pm.test(\"PlanDefinition: RaMonitoringRecommendation $apply with questionnaire generation\", function () {",
							"    pm.response.to.have.status(200)",
							"    const serviceRequest = pm.response.json().entry.find(e => e.resource?.resourceType === 'ServiceRequest')",
							"    pm.expect(serviceRequest, \"ServiceRequest resource is missing\").to.not.be.undefined",
							"    const qr = pm.response.json().entry.find(e => e.resource?.resourceType === 'QuestionnaireResponse')",
							"    pm.expect(qr, \"QuestionnaireResponse resource is missing\").to.not.be.undefined",
							"    const questionnaire = qr?.contained?.find(c => c.resourceType === 'Questionnaire')",
							"    pm.expect(questionnaire, \"Contained Questionnaire resource is missing in QuestionnaireResponse\").to.not.be.undefined",
							"    _.expectToDeepEqual(pm.response.json(), expected, console)",
							"})"
						],
						"type": "text/javascript",
						"packages": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json+fhir",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"resourceType\": \"Parameters\",\n    \"id\": \"RaMonitoringRecommendationParameters1\",\n    \"parameter\": [\n        {\n            \"name\": \"subject\",\n            \"valueString\": \"Patient/Patient1\"\n        },\n        {\n            \"name\": \"practitioner\",\n            \"valueString\": \"Practitioner/Practitioner1\"\n        },\n        {\n            \"name\": \"encounter\",\n            \"valueString\": \"Encounter/Encounter1\"\n        },\n        {\n        \"name\": \"planDefinition\",\n        \"resource\": {\n            \"resourceType\": \"PlanDefinition\",\n            \"id\": \"RaMonitoringRecommendation\",\n            \"meta\": {\n            \"profile\": [\n                \"http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-recommendationdefinition\"\n            ]\n            },\n            \"url\": \"http://example.org/PlanDefinition/RaMonitoringRecommendation\",\n            \"type\": {\n            \"coding\": [\n                {\n                \"system\": \"http://terminology.hl7.org/CodeSystem/plan-definition-type\",\n                \"code\": \"eca-rule\"\n                }\n            ]\n            },\n            \"name\": \"RaMonitoringRecommendation\",\n            \"title\": \"PlanDefinition RaMonitoringRecommendation\",\n            \"status\": \"draft\",\n            \"experimental\": true,\n            \"publisher\": \"Example\",\n            \"jurisdiction\": [\n            {\n                \"coding\": [\n                {\n                    \"code\": \"001\",\n                    \"system\": \"http://unstats.un.org/unsd/methods/m49/m49.htm\",\n                    \"display\": \"World\"\n                }\n                ]\n            }\n            ],\n            \"version\": \"0.1.0\",\n            \"description\": \"Monitoring tests for antirheumatic drug therapy for Ra.\",\n            \"library\": [\n            \"http://example.org/Library/RaMonitoringRecommendationLibrary\"\n            ],\n            \"action\": [\n            {\n                \"title\": \"Order monitoring tests for antirheumatic drug therapy.\",\n                \"description\": \"Order monitoring tests for antirheumatic drug therapy.\",\n                \"condition\": [\n                {\n                    \"kind\": \"applicability\",\n                    \"expression\": {\n                    \"language\": \"text/cql-identifier\",\n                    \"expression\": \"Order monitoring tests if on RA treatment\"\n                    }\n                }\n                ],\n                \"input\": [\n                {\n                    \"type\": \"Observation\",\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                }\n                ],\n                \"code\": [\n                {\n                    \"coding\": [\n                    {\n                        \"code\": \"diagnostic-testing\",\n                        \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"\n                    }\n                    ]\n                }\n                ],\n                \"definitionCanonical\": \"http://example.org/ActivityDefinition/OrderServiceActivity\"\n            }\n            ]\n        }\n        },\n        {\n        \"name\": \"data\",\n        \"resource\": {\n            \"resourceType\": \"Bundle\",\n            \"id\": \"PatientTestBundle1\",\n            \"type\": \"collection\",\n            \"entry\": [\n            {\n                \"resource\": {\n                \"resourceType\": \"Patient\",\n                \"id\": \"Patient1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Alice\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Encounter\",\n                \"id\": \"Encounter1\",\n                \"status\": \"in-progress\",\n                \"class\": {\n                    \"code\": \"AMB\",\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"participant\": [\n                    {\n                    \"individual\": {\n                        \"reference\": \"Practitioner/Practitioner1\"\n                    }\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Practitioner\",\n                \"id\": \"Practitioner1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Michael\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"MedicationRequest\",\n                \"id\": \"PastMedicationRequest\",\n                \"status\": \"active\",\n                \"intent\": \"order\",\n                \"authoredOn\": \"2023-01-01\",\n                \"medicationCodeableConcept\": {\n                    \"text\": \"Some medication\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"CurrentMedication\",\n                \"status\": \"active\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"PastMedication\",\n                \"form\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"pill\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Pill\"\n                    }\n                    ]\n                },\n                \"status\": \"inactive\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"DetectedIssue\",\n                \"id\": \"DetectedIssue1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"TIME\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\",\n                        \"display\": \"Time-related Detected Issue\"\n                    }\n                    ]\n                },\n                \"severity\": \"high\",\n                \"patient\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"identifiedDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Condition\",\n                \"id\": \"Condition1\",\n                \"clinicalStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"active\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-clinical\"\n                    }\n                    ]\n                },\n                \"verificationStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"provisional\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-ver-status\"\n                    }\n                    ]\n                },\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"problem-list-item\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-category\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"422504002\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Ischemic stroke (disorder)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"recordedDate\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"Inference1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"text\": \"Inference\",\n                    \"coding\": [\n                    {\n                        \"code\": \"448765001\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Unintentional weight loss (finding)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"effectiveDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Flag\",\n                \"id\": \"Flag1\",\n                \"status\": \"active\",\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"admin\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/flag-category\",\n                        \"display\": \"Administrative\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"text\": \"Flag\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"period\": {\n                    \"start\": \"2023-01-01\",\n                    \"end\": \"2024-01-01\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"ActiveRaTreatmentFeature1\",\n                \"meta\": {\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                },\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"on-ra-treatment\",\n                        \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                    }\n                    ]\n                },\n                \"derivedFrom\": [\n                    {\n                    \"reference\": \"QuestionnaireResponse/RaQuestionnaireResponse3\"\n                    }\n                ],\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"valueBoolean\": true\n                }\n            }\n            ]\n        }\n        },\n        {\n            \"name\": \"contentEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{contentEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"content\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{contentEndpointType}}\"\n                }\n            }\n        },\n        {\n            \"name\": \"terminologyEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{terminologyEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"terminology\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{terminologyEndpointType}}\"\n                }\n            }\n        }\n    ]\n}"
				},
				"url": {
					"raw": "{{cpgServer}}/PlanDefinition/$apply",
					"host": [
						"{{cpgServer}}"
					],
					"path": [
						"PlanDefinition",
						"$apply"
					]
				}
			},
			"response": []
		},
		{
			"name": "Scenario2 - RA Monitoring Recommendation",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const expected = {",
							"  \"resourceType\": \"Bundle\",",
							"  \"id\": \"RaMonitoringRecommendationExpected2\",",
							"  \"type\": \"collection\",",
							"  \"entry\": [",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/RequestGroup/RaMonitoringRecommendationRequestGroup2\",",
							"      \"resource\": {",
							"        \"resourceType\": \"RequestGroup\",",
							"        \"id\": \"RaMonitoringRecommendationRequestGroup2\",",
							"        \"intent\": \"proposal\",",
							"        \"status\": \"draft\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"instantiatesCanonical\": [",
							"          \"http://example.org/PlanDefinition/RaMonitoringRecommendation\"",
							"        ],",
							"        \"action\": [",
							"          {",
							"            \"title\": \"Order monitoring tests for antirheumatic drug therapy.\",",
							"            \"description\": \"Order monitoring tests for antirheumatic drug therapy.\",",
							"            \"code\": [",
							"              {",
							"                \"coding\": [",
							"                  {",
							"                    \"code\": \"diagnostic-testing\",",
							"                    \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"type\": {",
							"              \"coding\": [",
							"                {",
							"                  \"code\": \"create\",",
							"                  \"system\": \"http://terminology.hl7.org/CodeSystem/action-type\"",
							"                }",
							"              ]",
							"            },",
							"            \"condition\": [",
							"              {",
							"                \"kind\": \"applicability\",",
							"                \"expression\": {",
							"                  \"language\": \"text/cql-identifier\",",
							"                  \"expression\": \"Order monitoring tests if on RA treatment\"",
							"                }",
							"              }",
							"            ],",
							"            \"resource\": {",
							"              \"reference\": \"ServiceRequest/OrderTestingRequest2\"",
							"            }",
							"          }",
							"        ]",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/ServiceRequest/OrderTestingRequest2\",",
							"      \"resource\": {",
							"        \"resourceType\": \"ServiceRequest\",",
							"        \"id\": \"OrderTestingRequest2\",",
							"        \"meta\": {",
							"          \"profile\": [",
							"            \"http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-servicerequest\"",
							"          ]",
							"        },",
							"        \"status\": \"draft\",",
							"        \"doNotPerform\": false,",
							"        \"intent\": \"proposal\",",
							"        \"instantiatesCanonical\": [",
							"          \"http://example.org/ActivityDefinition/OrderServiceActivity\"",
							"        ],",
							"        \"code\": {",
							"          \"coding\": [",
							"            {",
							"              \"code\": \"order-service\",",
							"              \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-activity-type-cs\",",
							"              \"display\": \"Order a service\"",
							"            }",
							"          ]",
							"        },",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"encounter\": {",
							"          \"reference\": \"Encounter/Encounter1\"",
							"        },",
							"        \"requester\": {",
							"          \"reference\": \"Practitioner/Practitioner1\"",
							"        }",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",",
							"      \"resource\": {",
							"        \"resourceType\": \"QuestionnaireResponse\",",
							"        \"id\": \"RaQuestionnaireResponse2\",",
							"        \"questionnaire\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",",
							"        \"status\": \"completed\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"authored\": \"2023-12-06T11:45:33+11:00\",",
							"        \"author\": {",
							"          \"reference\": \"Practitioner/Practitioner1\"",
							"        },",
							"        \"item\": [",
							"          {",
							"            \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"            \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"            \"text\": \"Measurements and simple assertions\",",
							"            \"item\": [",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"text\": \"Actual result\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueBoolean\": true",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                \"text\": \"registered | preliminary | final | amended +\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"final\",",
							"                      \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                    }",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                \"text\": \"Type of observation (code / type)\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"on-ra-treatment\",",
							"                      \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                    }",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ],",
							"        \"contained\": [",
							"          {",
							"            \"resourceType\": \"Questionnaire\",",
							"            \"id\": \"RaQuestionnaire2\",",
							"            \"item\": [",
							"              {",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-itemPopulationContext\",",
							"                    \"valueExpression\": {",
							"                      \"language\": \"text/cql-identifier\",",
							"                      \"expression\": \"On RA Treatment\",",
							"                      \"reference\": \"http://example.org/Library/ActiveRaTreatmentFeatureLogic\",",
							"                      \"name\": \"ActiveRaTreatmentFeature\"",
							"                    }",
							"                  }",
							"                ],",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"                \"text\": \"Measurements and simple assertions\",",
							"                \"type\": \"group\",",
							"                \"item\": [",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"registered | preliminary | final | amended +\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"final\",",
							"                          \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"Type of observation (code / type)\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"on-ra-treatment\",",
							"                          \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"text\": \"Actual result\",",
							"                    \"type\": \"boolean\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\",",
							"                        \"valueExpression\": {",
							"                          \"language\": \"text/cql-expression\",",
							"                          \"expression\": \"%ActiveRaTreatmentFeature.value[x]\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"url\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",",
							"            \"status\": \"draft\",",
							"            \"extension\": [",
							"              {",
							"                \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext\",",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"name\",",
							"                    \"valueCoding\": {",
							"                      \"code\": \"patient\",",
							"                      \"system\": \"http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext\"",
							"                    }",
							"                  },",
							"                  {",
							"                    \"url\": \"type\",",
							"                    \"valueCode\": \"Patient\"",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ]",
							"      }",
							"    }",
							"  ]",
							"}",
							"",
							"",
							"",
							"",
							"pm.test(\"PlanDefinition: RaMonitoringRecommendation $apply with questionnaire generation\", function () {",
							"    pm.response.to.have.status(200)",
							"    const serviceRequest = pm.response.json().entry.find(e => e.resource?.resourceType === 'ServiceRequest')",
							"    pm.expect(serviceRequest, \"ServiceRequest resource is missing\").to.not.be.undefined",
							"    const qr = pm.response.json().entry.find(e => e.resource?.resourceType === 'QuestionnaireResponse')",
							"    pm.expect(qr, \"QuestionnaireResponse resource is missing\").to.not.be.undefined",
							"    const questionnaire = qr?.contained?.find(c => c.resourceType === 'Questionnaire')",
							"    pm.expect(questionnaire, \"Contained Questionnaire resource is missing in QuestionnaireResponse\").to.not.be.undefined",
							"    _.expectToDeepEqual(pm.response.json(), expected, console)",
							"})"
						],
						"type": "text/javascript",
						"packages": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json+fhir",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"resourceType\": \"Parameters\",\n    \"id\": \"RaMonitoringRecommendationParameters2\",\n    \"parameter\": [\n        {\n            \"name\": \"subject\",\n            \"valueString\": \"Patient/Patient1\"\n        },\n        {\n            \"name\": \"practitioner\",\n            \"valueString\": \"Practitioner/Practitioner1\"\n        },\n        {\n            \"name\": \"encounter\",\n            \"valueString\": \"Encounter/Encounter1\"\n        },\n        {\n        \"name\": \"planDefinition\",\n        \"resource\": {\n            \"resourceType\": \"PlanDefinition\",\n            \"id\": \"RaMonitoringRecommendation\",\n            \"meta\": {\n            \"profile\": [\n                \"http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-recommendationdefinition\"\n            ]\n            },\n            \"url\": \"http://example.org/PlanDefinition/RaMonitoringRecommendation\",\n            \"type\": {\n            \"coding\": [\n                {\n                \"system\": \"http://terminology.hl7.org/CodeSystem/plan-definition-type\",\n                \"code\": \"eca-rule\"\n                }\n            ]\n            },\n            \"name\": \"RaMonitoringRecommendation\",\n            \"title\": \"PlanDefinition RaMonitoringRecommendation\",\n            \"status\": \"draft\",\n            \"experimental\": true,\n            \"publisher\": \"Example\",\n            \"jurisdiction\": [\n            {\n                \"coding\": [\n                {\n                    \"code\": \"001\",\n                    \"system\": \"http://unstats.un.org/unsd/methods/m49/m49.htm\",\n                    \"display\": \"World\"\n                }\n                ]\n            }\n            ],\n            \"version\": \"0.1.0\",\n            \"description\": \"Monitoring tests for antirheumatic drug therapy for Ra.\",\n            \"library\": [\n            \"http://example.org/Library/RaMonitoringRecommendationLibrary\"\n            ],\n            \"action\": [\n            {\n                \"title\": \"Order monitoring tests for antirheumatic drug therapy.\",\n                \"description\": \"Order monitoring tests for antirheumatic drug therapy.\",\n                \"condition\": [\n                {\n                    \"kind\": \"applicability\",\n                    \"expression\": {\n                    \"language\": \"text/cql-identifier\",\n                    \"expression\": \"Order monitoring tests if on RA treatment\"\n                    }\n                }\n                ],\n                \"input\": [\n                {\n                    \"type\": \"Observation\",\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                }\n                ],\n                \"code\": [\n                {\n                    \"coding\": [\n                    {\n                        \"code\": \"diagnostic-testing\",\n                        \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"\n                    }\n                    ]\n                }\n                ],\n                \"definitionCanonical\": \"http://example.org/ActivityDefinition/OrderServiceActivity\"\n            }\n            ]\n        }\n        },\n        {\n        \"name\": \"data\",\n        \"resource\": {\n            \"resourceType\": \"Bundle\",\n            \"id\": \"PatientTestBundle1\",\n            \"type\": \"collection\",\n            \"entry\": [\n            {\n                \"resource\": {\n                \"resourceType\": \"Patient\",\n                \"id\": \"Patient1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Alice\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Encounter\",\n                \"id\": \"Encounter1\",\n                \"status\": \"in-progress\",\n                \"class\": {\n                    \"code\": \"AMB\",\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"participant\": [\n                    {\n                    \"individual\": {\n                        \"reference\": \"Practitioner/Practitioner1\"\n                    }\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Practitioner\",\n                \"id\": \"Practitioner1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Michael\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"MedicationRequest\",\n                \"id\": \"PastMedicationRequest\",\n                \"status\": \"active\",\n                \"intent\": \"order\",\n                \"authoredOn\": \"2023-01-01\",\n                \"medicationCodeableConcept\": {\n                    \"text\": \"Some medication\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"CurrentMedication\",\n                \"status\": \"active\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"PastMedication\",\n                \"form\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"pill\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Pill\"\n                    }\n                    ]\n                },\n                \"status\": \"inactive\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"DetectedIssue\",\n                \"id\": \"DetectedIssue1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"TIME\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\",\n                        \"display\": \"Time-related Detected Issue\"\n                    }\n                    ]\n                },\n                \"severity\": \"high\",\n                \"patient\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"identifiedDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Condition\",\n                \"id\": \"Condition1\",\n                \"clinicalStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"active\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-clinical\"\n                    }\n                    ]\n                },\n                \"verificationStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"provisional\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-ver-status\"\n                    }\n                    ]\n                },\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"problem-list-item\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-category\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"422504002\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Ischemic stroke (disorder)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"recordedDate\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"Inference1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"text\": \"Inference\",\n                    \"coding\": [\n                    {\n                        \"code\": \"448765001\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Unintentional weight loss (finding)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"effectiveDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Flag\",\n                \"id\": \"Flag1\",\n                \"status\": \"active\",\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"admin\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/flag-category\",\n                        \"display\": \"Administrative\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"text\": \"Flag\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"period\": {\n                    \"start\": \"2023-01-01\",\n                    \"end\": \"2024-01-01\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"ActiveRaTreatmentFeature1\",\n                \"meta\": {\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                },\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"on-ra-treatment\",\n                        \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                    }\n                    ]\n                },\n                \"derivedFrom\": [\n                    {\n                    \"reference\": \"QuestionnaireResponse/RaQuestionnaireResponse3\"\n                    }\n                ],\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"valueBoolean\": true\n                }\n            }\n            ]\n        }\n        },\n        {\n        \"name\": \"questionnaireResponse\",\n        \"resource\": {\n            \"resourceType\": \"QuestionnaireResponse\",\n            \"id\": \"RaQuestionnaireResponse2\",\n            \"questionnaire\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",\n            \"status\": \"completed\",\n            \"subject\": {\n            \"reference\": \"Patient/Patient1\"\n            },\n            \"authored\": \"2023-12-06T11:45:33+11:00\",\n            \"author\": {\n            \"reference\": \"Practitioner/Practitioner1\"\n            },\n            \"item\": [\n            {\n                \"linkId\": \"ActiveRaTreatmentFeature#Observation\",\n                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",\n                \"text\": \"Measurements and simple assertions\",\n                \"item\": [\n                {\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                    \"text\": \"Actual result\",\n                    \"answer\": [\n                    {\n                        \"valueBoolean\": true\n                    }\n                    ]\n                },\n                {\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",\n                    \"text\": \"registered | preliminary | final | amended +\",\n                    \"answer\": [\n                    {\n                        \"valueCoding\": {\n                        \"code\": \"final\",\n                        \"system\": \"http://hl7.org/fhir/observation-status\"\n                        }\n                    }\n                    ]\n                },\n                {\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",\n                    \"text\": \"Type of observation (code / type)\",\n                    \"answer\": [\n                    {\n                        \"valueCoding\": {\n                        \"code\": \"on-ra-treatment\",\n                        \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                        }\n                    }\n                    ]\n                }\n                ]\n            }\n            ],\n            \"contained\": [\n            {\n                \"resourceType\": \"Questionnaire\",\n                \"id\": \"RaQuestionnaire2\",\n                \"item\": [\n                {\n                    \"extension\": [\n                    {\n                        \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-itemPopulationContext\",\n                        \"valueExpression\": {\n                        \"language\": \"text/cql-identifier\",\n                        \"expression\": \"On RA Treatment\",\n                        \"reference\": \"http://example.org/Library/ActiveRaTreatmentFeatureLogic\",\n                        \"name\": \"ActiveRaTreatmentFeature\"\n                        }\n                    }\n                    ],\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",\n                    \"text\": \"Measurements and simple assertions\",\n                    \"type\": \"group\",\n                    \"item\": [\n                    {\n                        \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",\n                        \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",\n                        \"extension\": [\n                        {\n                            \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",\n                            \"valueBoolean\": true\n                        }\n                        ],\n                        \"text\": \"registered | preliminary | final | amended +\",\n                        \"required\": true,\n                        \"type\": \"choice\",\n                        \"initial\": [\n                        {\n                            \"valueCoding\": {\n                            \"code\": \"final\",\n                            \"system\": \"http://hl7.org/fhir/observation-status\"\n                            }\n                        }\n                        ]\n                    },\n                    {\n                        \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",\n                        \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",\n                        \"extension\": [\n                        {\n                            \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",\n                            \"valueBoolean\": true\n                        }\n                        ],\n                        \"text\": \"Type of observation (code / type)\",\n                        \"required\": true,\n                        \"type\": \"choice\",\n                        \"initial\": [\n                        {\n                            \"valueCoding\": {\n                            \"code\": \"on-ra-treatment\",\n                            \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                            }\n                        }\n                        ]\n                    },\n                    {\n                        \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                        \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                        \"text\": \"Actual result\",\n                        \"type\": \"boolean\",\n                        \"extension\": [\n                        {\n                            \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\",\n                            \"valueExpression\": {\n                            \"language\": \"text/cql-expression\",\n                            \"expression\": \"%ActiveRaTreatmentFeature.value[x]\"\n                            }\n                        }\n                        ]\n                    }\n                    ]\n                }\n                ],\n                \"url\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",\n                \"status\": \"draft\",\n                \"extension\": [\n                {\n                    \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext\",\n                    \"extension\": [\n                    {\n                        \"url\": \"name\",\n                        \"valueCoding\": {\n                        \"code\": \"patient\",\n                        \"system\": \"http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext\"\n                        }\n                    },\n                    {\n                        \"url\": \"type\",\n                        \"valueCode\": \"Patient\"\n                    }\n                    ]\n                }\n                ]\n            }\n            ]\n        }\n        },\n        {\n            \"name\": \"contentEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{contentEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"content\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{contentEndpointType}}\"\n                }\n            }\n        },\n        {\n            \"name\": \"terminologyEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{terminologyEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"terminology\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{terminologyEndpointType}}\"\n                }\n            }\n        }\n    ]\n}"
				},
				"url": {
					"raw": "{{cpgServer}}/PlanDefinition/$apply",
					"host": [
						"{{cpgServer}}"
					],
					"path": [
						"PlanDefinition",
						"$apply"
					]
				}
			},
			"response": []
		},
		{
			"name": "Scenario3 - RA Monitoring Recommendation",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const expected = {",
							"  \"resourceType\": \"Bundle\",",
							"  \"id\": \"RaMonitoringRecommendationExpected3\",",
							"  \"type\": \"collection\",",
							"  \"entry\": [",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/RequestGroup/RaMonitoringRecommendationRequestGroup3\",",
							"      \"resource\": {",
							"        \"resourceType\": \"RequestGroup\",",
							"        \"id\": \"RaMonitoringRecommendationRequestGroup3\",",
							"        \"intent\": \"proposal\",",
							"        \"status\": \"draft\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"instantiatesCanonical\": [",
							"          \"http://example.org/PlanDefinition/RaMonitoringRecommendation\"",
							"        ]",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/QuestionnaireResponse/RaQuestionnaireResponse3\",",
							"      \"resource\": {",
							"        \"resourceType\": \"QuestionnaireResponse\",",
							"        \"id\": \"RaQuestionnaireResponse3\",",
							"        \"questionnaire\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",",
							"        \"status\": \"completed\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"authored\": \"2023-12-06T11:45:33+11:00\",",
							"        \"author\": {",
							"          \"reference\": \"Practitioner/Practitioner1\"",
							"        },",
							"        \"item\": [",
							"          {",
							"            \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"            \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"            \"text\": \"Measurements and simple assertions\",",
							"            \"item\": [",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"text\": \"Actual result\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueBoolean\": false",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                \"text\": \"registered | preliminary | final | amended +\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"final\",",
							"                      \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                    }",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                \"text\": \"Type of observation (code / type)\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"on-ra-treatment\",",
							"                      \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                    }",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ],",
							"        \"contained\": [",
							"          {",
							"            \"resourceType\": \"Questionnaire\",",
							"            \"id\": \"RaQuestionnaire3\",",
							"            \"item\": [",
							"              {",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-itemPopulationContext\",",
							"                    \"valueExpression\": {",
							"                      \"language\": \"text/cql-identifier\",",
							"                      \"expression\": \"On RA Treatment\",",
							"                      \"reference\": \"http://example.org/Library/ActiveRaTreatmentFeatureLogic\",",
							"                      \"name\": \"ActiveRaTreatmentFeature\"",
							"                    }",
							"                  }",
							"                ],",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"                \"text\": \"Measurements and simple assertions\",",
							"                \"type\": \"group\",",
							"                \"item\": [",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"registered | preliminary | final | amended +\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"final\",",
							"                          \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"Type of observation (code / type)\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"on-ra-treatment\",",
							"                          \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"text\": \"Actual result\",",
							"                    \"type\": \"boolean\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\",",
							"                        \"valueExpression\": {",
							"                          \"language\": \"text/cql-expression\",",
							"                          \"expression\": \"%ActiveRaTreatmentFeature.value[x]\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"url\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",",
							"            \"status\": \"draft\",",
							"            \"extension\": [",
							"              {",
							"                \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext\",",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"name\",",
							"                    \"valueCoding\": {",
							"                      \"code\": \"patient\",",
							"                      \"system\": \"http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext\"",
							"                    }",
							"                  },",
							"                  {",
							"                    \"url\": \"type\",",
							"                    \"valueCode\": \"Patient\"",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ]",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/Observation/ActiveRaTreatmentFeature3\",",
							"      \"resource\": {",
							"        \"resourceType\": \"Observation\",",
							"        \"id\": \"ActiveRaTreatmentFeature3\",",
							"        \"meta\": {",
							"          \"profile\": [",
							"            \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"",
							"          ]",
							"        },",
							"        \"status\": \"final\",",
							"        \"code\": {",
							"          \"coding\": [",
							"            {",
							"              \"code\": \"on-ra-treatment\",",
							"              \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"            }",
							"          ]",
							"        },",
							"        \"derivedFrom\": [",
							"          {",
							"            \"reference\": \"QuestionnaireResponse/RaQuestionnaireResponse3\"",
							"          }",
							"        ],",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"valueBoolean\": false",
							"      }",
							"    }",
							"  ]",
							"}",
							"",
							"",
							"",
							"",
							"pm.test(\"PlanDefinition: RaMonitoringRecommendation $apply with questionnaire generation\", function () {",
							"    pm.response.to.have.status(200)",
							"    const serviceRequest = pm.response.json().entry.find(e => e.resource?.resourceType === 'ServiceRequest')",
							"    pm.expect(serviceRequest, \"ServiceRequest resource is present but not expected\").to.be.undefined",
							"    const qr = pm.response.json().entry.find(e => e.resource?.resourceType === 'QuestionnaireResponse')",
							"    pm.expect(qr, \"QuestionnaireResponse resource is missing\").to.not.be.undefined",
							"    const questionnaire = qr?.contained?.find(c => c.resourceType === 'Questionnaire')",
							"    pm.expect(questionnaire, \"Contained Questionnaire resource is missing in QuestionnaireResponse\").to.not.be.undefined",
							"    const caseFeature = pm.response.json().entry.find(e => e.resource?.resourceType === 'Observation')",
							"    pm.expect(caseFeature, \"Extracted case feature is missing\").to.not.be.undefined",
							"    _.expectToDeepEqual(pm.response.json(), expected, console)",
							"})"
						],
						"type": "text/javascript",
						"packages": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json+fhir",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"resourceType\": \"Parameters\",\n    \"id\": \"RaMonitoringRecommendationParameters3\",\n    \"parameter\": [\n        {\n            \"name\": \"subject\",\n            \"valueString\": \"Patient/Patient1\"\n        },\n        {\n            \"name\": \"practitioner\",\n            \"valueString\": \"Practitioner/Practitioner1\"\n        },\n        {\n            \"name\": \"encounter\",\n            \"valueString\": \"Encounter/Encounter1\"\n        },\n        {\n        \"name\": \"planDefinition\",\n        \"resource\": {\n            \"resourceType\": \"PlanDefinition\",\n            \"id\": \"RaMonitoringRecommendation\",\n            \"meta\": {\n            \"profile\": [\n                \"http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-recommendationdefinition\"\n            ]\n            },\n            \"url\": \"http://example.org/PlanDefinition/RaMonitoringRecommendation\",\n            \"type\": {\n            \"coding\": [\n                {\n                \"system\": \"http://terminology.hl7.org/CodeSystem/plan-definition-type\",\n                \"code\": \"eca-rule\"\n                }\n            ]\n            },\n            \"name\": \"RaMonitoringRecommendation\",\n            \"title\": \"PlanDefinition RaMonitoringRecommendation\",\n            \"status\": \"draft\",\n            \"experimental\": true,\n            \"publisher\": \"Example\",\n            \"jurisdiction\": [\n            {\n                \"coding\": [\n                {\n                    \"code\": \"001\",\n                    \"system\": \"http://unstats.un.org/unsd/methods/m49/m49.htm\",\n                    \"display\": \"World\"\n                }\n                ]\n            }\n            ],\n            \"version\": \"0.1.0\",\n            \"description\": \"Monitoring tests for antirheumatic drug therapy for Ra.\",\n            \"library\": [\n            \"http://example.org/Library/RaMonitoringRecommendationLibrary\"\n            ],\n            \"action\": [\n            {\n                \"title\": \"Order monitoring tests for antirheumatic drug therapy.\",\n                \"description\": \"Order monitoring tests for antirheumatic drug therapy.\",\n                \"condition\": [\n                {\n                    \"kind\": \"applicability\",\n                    \"expression\": {\n                    \"language\": \"text/cql-identifier\",\n                    \"expression\": \"Order monitoring tests if on RA treatment\"\n                    }\n                }\n                ],\n                \"input\": [\n                {\n                    \"type\": \"Observation\",\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                }\n                ],\n                \"code\": [\n                {\n                    \"coding\": [\n                    {\n                        \"code\": \"diagnostic-testing\",\n                        \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"\n                    }\n                    ]\n                }\n                ],\n                \"definitionCanonical\": \"http://example.org/ActivityDefinition/OrderServiceActivity\"\n            }\n            ]\n        }\n        },\n        {\n        \"name\": \"data\",\n        \"resource\": {\n            \"resourceType\": \"Bundle\",\n            \"id\": \"PatientTestBundle1\",\n            \"type\": \"collection\",\n            \"entry\": [\n            {\n                \"resource\": {\n                \"resourceType\": \"Patient\",\n                \"id\": \"Patient1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Alice\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Encounter\",\n                \"id\": \"Encounter1\",\n                \"status\": \"in-progress\",\n                \"class\": {\n                    \"code\": \"AMB\",\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"participant\": [\n                    {\n                    \"individual\": {\n                        \"reference\": \"Practitioner/Practitioner1\"\n                    }\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Practitioner\",\n                \"id\": \"Practitioner1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Michael\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"MedicationRequest\",\n                \"id\": \"PastMedicationRequest\",\n                \"status\": \"active\",\n                \"intent\": \"order\",\n                \"authoredOn\": \"2023-01-01\",\n                \"medicationCodeableConcept\": {\n                    \"text\": \"Some medication\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"CurrentMedication\",\n                \"status\": \"active\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"PastMedication\",\n                \"form\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"pill\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Pill\"\n                    }\n                    ]\n                },\n                \"status\": \"inactive\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"DetectedIssue\",\n                \"id\": \"DetectedIssue1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"TIME\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\",\n                        \"display\": \"Time-related Detected Issue\"\n                    }\n                    ]\n                },\n                \"severity\": \"high\",\n                \"patient\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"identifiedDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Condition\",\n                \"id\": \"Condition1\",\n                \"clinicalStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"active\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-clinical\"\n                    }\n                    ]\n                },\n                \"verificationStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"provisional\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-ver-status\"\n                    }\n                    ]\n                },\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"problem-list-item\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-category\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"422504002\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Ischemic stroke (disorder)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"recordedDate\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"Inference1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"text\": \"Inference\",\n                    \"coding\": [\n                    {\n                        \"code\": \"448765001\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Unintentional weight loss (finding)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"effectiveDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Flag\",\n                \"id\": \"Flag1\",\n                \"status\": \"active\",\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"admin\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/flag-category\",\n                        \"display\": \"Administrative\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"text\": \"Flag\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"period\": {\n                    \"start\": \"2023-01-01\",\n                    \"end\": \"2024-01-01\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"ActiveRaTreatmentFeature1\",\n                \"meta\": {\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                },\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"on-ra-treatment\",\n                        \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                    }\n                    ]\n                },\n                \"derivedFrom\": [\n                    {\n                    \"reference\": \"QuestionnaireResponse/RaQuestionnaireResponse3\"\n                    }\n                ],\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"valueBoolean\": true\n                }\n            }\n            ]\n        }\n        },\n        {\n        \"name\": \"questionnaireResponse\",\n        \"resource\": {\n            \"resourceType\": \"QuestionnaireResponse\",\n            \"id\": \"RaQuestionnaireResponse3\",\n            \"questionnaire\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",\n            \"status\": \"completed\",\n            \"subject\": {\n            \"reference\": \"Patient/Patient1\"\n            },\n            \"authored\": \"2023-12-06T11:45:33+11:00\",\n            \"author\": {\n            \"reference\": \"Practitioner/Practitioner1\"\n            },\n            \"item\": [\n            {\n                \"linkId\": \"ActiveRaTreatmentFeature#Observation\",\n                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",\n                \"text\": \"Measurements and simple assertions\",\n                \"item\": [\n                {\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                    \"text\": \"Actual result\",\n                    \"answer\": [\n                    {\n                        \"valueBoolean\": false\n                    }\n                    ]\n                },\n                {\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",\n                    \"text\": \"registered | preliminary | final | amended +\",\n                    \"answer\": [\n                    {\n                        \"valueCoding\": {\n                        \"code\": \"final\",\n                        \"system\": \"http://hl7.org/fhir/observation-status\"\n                        }\n                    }\n                    ]\n                },\n                {\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",\n                    \"text\": \"Type of observation (code / type)\",\n                    \"answer\": [\n                    {\n                        \"valueCoding\": {\n                        \"code\": \"on-ra-treatment\",\n                        \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                        }\n                    }\n                    ]\n                }\n                ]\n            }\n            ],\n            \"contained\": [\n            {\n                \"resourceType\": \"Questionnaire\",\n                \"id\": \"RaQuestionnaire3\",\n                \"item\": [\n                {\n                    \"extension\": [\n                    {\n                        \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-itemPopulationContext\",\n                        \"valueExpression\": {\n                        \"language\": \"text/cql-identifier\",\n                        \"expression\": \"On RA Treatment\",\n                        \"reference\": \"http://example.org/Library/ActiveRaTreatmentFeatureLogic\",\n                        \"name\": \"ActiveRaTreatmentFeature\"\n                        }\n                    }\n                    ],\n                    \"linkId\": \"ActiveRaTreatmentFeature#Observation\",\n                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",\n                    \"text\": \"Measurements and simple assertions\",\n                    \"type\": \"group\",\n                    \"item\": [\n                    {\n                        \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",\n                        \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",\n                        \"extension\": [\n                        {\n                            \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",\n                            \"valueBoolean\": true\n                        }\n                        ],\n                        \"text\": \"registered | preliminary | final | amended +\",\n                        \"required\": true,\n                        \"type\": \"choice\",\n                        \"initial\": [\n                        {\n                            \"valueCoding\": {\n                            \"code\": \"final\",\n                            \"system\": \"http://hl7.org/fhir/observation-status\"\n                            }\n                        }\n                        ]\n                    },\n                    {\n                        \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",\n                        \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",\n                        \"extension\": [\n                        {\n                            \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",\n                            \"valueBoolean\": true\n                        }\n                        ],\n                        \"text\": \"Type of observation (code / type)\",\n                        \"required\": true,\n                        \"type\": \"choice\",\n                        \"initial\": [\n                        {\n                            \"valueCoding\": {\n                            \"code\": \"on-ra-treatment\",\n                            \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                            }\n                        }\n                        ]\n                    },\n                    {\n                        \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                        \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",\n                        \"text\": \"Actual result\",\n                        \"type\": \"boolean\",\n                        \"extension\": [\n                        {\n                            \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\",\n                            \"valueExpression\": {\n                            \"language\": \"text/cql-expression\",\n                            \"expression\": \"%ActiveRaTreatmentFeature.value[x]\"\n                            }\n                        }\n                        ]\n                    }\n                    ]\n                }\n                ],\n                \"url\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire2\",\n                \"status\": \"draft\",\n                \"extension\": [\n                {\n                    \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext\",\n                    \"extension\": [\n                    {\n                        \"url\": \"name\",\n                        \"valueCoding\": {\n                        \"code\": \"patient\",\n                        \"system\": \"http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext\"\n                        }\n                    },\n                    {\n                        \"url\": \"type\",\n                        \"valueCode\": \"Patient\"\n                    }\n                    ]\n                }\n                ]\n            }\n            ]\n        }\n        },\n        {\n            \"name\": \"contentEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{contentEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"content\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{contentEndpointType}}\"\n                }\n            }\n        },\n        {\n            \"name\": \"terminologyEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{terminologyEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"terminology\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{terminologyEndpointType}}\"\n                }\n            }\n        }\n    ]\n}"
				},
				"url": {
					"raw": "{{cpgServer}}/PlanDefinition/$apply",
					"host": [
						"{{cpgServer}}"
					],
					"path": [
						"PlanDefinition",
						"$apply"
					]
				}
			},
			"response": []
		},
		{
			"name": "Scenario 1 - RA Monitoring Strategy",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const expected = {",
							"  \"resourceType\": \"Bundle\",",
							"  \"id\": \"RaMonitoringStrategyExpected\",",
							"  \"type\": \"collection\",",
							"  \"entry\": [",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/RequestGroup/RaMonitoringRecommendationRequestGroup4\",",
							"      \"resource\": {",
							"        \"resourceType\": \"RequestGroup\",",
							"        \"id\": \"RaMonitoringRecommendationRequestGroup4\",",
							"        \"intent\": \"proposal\",",
							"        \"status\": \"draft\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"instantiatesCanonical\": [",
							"          \"http://example.org/PlanDefinition/RaMonitoringRecommendation\"",
							"        ],",
							"        \"action\": [",
							"          {",
							"            \"title\": \"Order monitoring tests for antirheumatic drug therapy.\",",
							"            \"description\": \"Order monitoring tests for antirheumatic drug therapy.\",",
							"            \"code\": [",
							"              {",
							"                \"coding\": [",
							"                  {",
							"                    \"code\": \"diagnostic-testing\",",
							"                    \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"type\": {",
							"              \"coding\": [",
							"                {",
							"                  \"code\": \"create\",",
							"                  \"system\": \"http://terminology.hl7.org/CodeSystem/action-type\"",
							"                }",
							"              ]",
							"            },",
							"            \"condition\": [",
							"              {",
							"                \"kind\": \"applicability\",",
							"                \"expression\": {",
							"                  \"language\": \"text/cql-identifier\",",
							"                  \"expression\": \"Order monitoring tests if on RA treatment\"",
							"                }",
							"              }",
							"            ],",
							"            \"resource\": {",
							"              \"reference\": \"ServiceRequest/OrderTestingRequest4\"",
							"            }",
							"          }",
							"        ]",
							"      }",
							"    },",
							"    {",
							"      \"fullUrl\": \"http://apply-processor/QuestionnaireResponse/OrderTestingRequest1\",",
							"      \"resource\": {",
							"        \"resourceType\": \"QuestionnaireResponse\",",
							"        \"id\": \"RaQuestionnaireResponse4\",",
							"        \"questionnaire\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire1\",",
							"        \"status\": \"completed\",",
							"        \"subject\": {",
							"          \"reference\": \"Patient/Patient1\"",
							"        },",
							"        \"authored\": \"2023-12-06T11:45:33+11:00\",",
							"        \"author\": {",
							"          \"reference\": \"Practitioner/Practitioner1\"",
							"        },",
							"        \"item\": [",
							"          {",
							"            \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"            \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"            \"text\": \"Measurements and simple assertions\",",
							"            \"item\": [",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                \"text\": \"Actual result\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueBoolean\": false",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                \"text\": \"registered | preliminary | final | amended +\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"final\",",
							"                      \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                    }",
							"                  }",
							"                ]",
							"              },",
							"              {",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                \"text\": \"Type of observation (code / type)\",",
							"                \"answer\": [",
							"                  {",
							"                    \"valueCoding\": {",
							"                      \"code\": \"on-ra-treatment\",",
							"                      \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                    }",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ],",
							"        \"contained\": [",
							"          {",
							"            \"resourceType\": \"Questionnaire\",",
							"            \"id\": \"RaQuestionnaire4\",",
							"            \"item\": [",
							"              {",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-itemPopulationContext\",",
							"                    \"valueExpression\": {",
							"                      \"language\": \"text/cql-identifier\",",
							"                      \"expression\": \"On RA Treatment\",",
							"                      \"reference\": \"http://example.org/Library/ActiveRaTreatmentFeatureLogic\",",
							"                      \"name\": \"ActiveRaTreatmentFeature\"",
							"                    }",
							"                  }",
							"                ],",
							"                \"linkId\": \"ActiveRaTreatmentFeature#Observation\",",
							"                \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation\",",
							"                \"text\": \"Measurements and simple assertions\",",
							"                \"type\": \"group\",",
							"                \"item\": [",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.status\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"registered | preliminary | final | amended +\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"final\",",
							"                          \"system\": \"http://hl7.org/fhir/observation-status\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.code\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-hidden\",",
							"                        \"valueBoolean\": true",
							"                      }",
							"                    ],",
							"                    \"text\": \"Type of observation (code / type)\",",
							"                    \"required\": true,",
							"                    \"type\": \"choice\",",
							"                    \"initial\": [",
							"                      {",
							"                        \"valueCoding\": {",
							"                          \"code\": \"on-ra-treatment\",",
							"                          \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  },",
							"                  {",
							"                    \"linkId\": \"ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"definition\": \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature#Observation.valueBoolean\",",
							"                    \"text\": \"Actual result\",",
							"                    \"type\": \"boolean\",",
							"                    \"extension\": [",
							"                      {",
							"                        \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-initialExpression\",",
							"                        \"valueExpression\": {",
							"                          \"language\": \"text/cql-expression\",",
							"                          \"expression\": \"%ActiveRaTreatmentFeature.value[x]\"",
							"                        }",
							"                      }",
							"                    ]",
							"                  }",
							"                ]",
							"              }",
							"            ],",
							"            \"url\": \"http://questionnaire-processor/Questionnaire/RaQuestionnaire1\",",
							"            \"status\": \"draft\",",
							"            \"extension\": [",
							"              {",
							"                \"url\": \"http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-launchContext\",",
							"                \"extension\": [",
							"                  {",
							"                    \"url\": \"name\",",
							"                    \"valueCoding\": {",
							"                      \"code\": \"patient\",",
							"                      \"system\": \"http://hl7.org/fhir/uv/sdc/CodeSystem/launchContext\"",
							"                    }",
							"                  },",
							"                  {",
							"                    \"url\": \"type\",",
							"                    \"valueCode\": \"Patient\"",
							"                  }",
							"                ]",
							"              }",
							"            ]",
							"          }",
							"        ]",
							"      }",
							"    }",
							"  ]",
							"}",
							"",
							"pm.test(\"PlanDefinition: RaMonitoringStrategy $apply with questionnaire generation\", function () {",
							"    pm.response.to.have.status(200)",
							"    const serviceRequest = pm.response.json().entry.find(e => e.resource?.resourceType === 'ServiceRequest')",
							"    pm.expect(serviceRequest, \"ServiceRequest resource is missing\").to.not.be.undefined",
							"    const qr = pm.response.json().entry.find(e => e.resource?.resourceType === 'QuestionnaireResponse')",
							"    pm.expect(qr, \"QuestionnaireResponse resource is missing\").to.not.be.undefined",
							"    const questionnaire = qr?.contained?.find(c => c.resourceType === 'Questionnaire')",
							"    pm.expect(questionnaire, \"Contained Questionnaire resource is missing in QuestionnaireResponse\").to.not.be.undefined",
							"    _.expectToDeepEqual(pm.response.json(), expected, console)",
							"})",
							""
						],
						"type": "text/javascript",
						"packages": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"resourceType\": \"Parameters\",\n    \"id\": \"RaMonitoringStrategyParameters\",\n    \"parameter\": [\n        {\n            \"name\": \"subject\",\n            \"valueString\": \"Patient/Patient1\"\n        },\n        {\n            \"name\": \"practitioner\",\n            \"valueString\": \"Practitioner/Practitioner1\"\n        },\n        {\n            \"name\": \"encounter\",\n            \"valueString\": \"Encounter/Encounter1\"\n        },\n        {\n        \"name\": \"planDefinition\",\n        \"resource\": {\n            \"resourceType\": \"PlanDefinition\",\n            \"id\": \"RaMonitoringStrategy\",\n            \"meta\": {\n            \"profile\": [\n                \"http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-strategydefinition\"\n            ]\n            },\n            \"url\": \"http://example.org/PlanDefinition/RaMonitoringStrategy\",\n            \"type\": {\n            \"coding\": [\n                {\n                \"system\": \"http://terminology.hl7.org/CodeSystem/plan-definition-type\",\n                \"code\": \"workflow-definition\"\n                }\n            ]\n            },\n            \"name\": \"RaMonitoringStrategy\",\n            \"title\": \"PlanDefinition RaMonitoringStrategy\",\n            \"status\": \"draft\",\n            \"experimental\": true,\n            \"publisher\": \"Example\",\n            \"jurisdiction\": [\n            {\n                \"coding\": [\n                {\n                    \"code\": \"001\",\n                    \"system\": \"http://unstats.un.org/unsd/methods/m49/m49.htm\",\n                    \"display\": \"World\"\n                }\n                ]\n            }\n            ],\n            \"version\": \"0.1.0\",\n            \"description\": \"Strategy for monitoring tests for antirheumatic drug therapy for Ra.\",\n            \"action\": [\n            {\n                \"title\": \"Recommend monitoring tests for antirheumatic drug therapy.\",\n                \"description\": \"Recommend monitoring tests for antirheumatic drug therapy.\",\n                \"code\": [\n                {\n                    \"coding\": [\n                    {\n                        \"code\": \"guideline-based-care\",\n                        \"system\": \"http://hl7.org/fhir/uv/cpg/CodeSystem/cpg-common-process-cs\"\n                    }\n                    ]\n                }\n                ],\n                \"definitionCanonical\": \"http://example.org/PlanDefinition/RaMonitoringRecommendation\"\n            }\n            ]\n        }\n        },\n        {\n        \"name\": \"data\",\n        \"resource\": {\n            \"resourceType\": \"Bundle\",\n            \"id\": \"PatientTestBundle1\",\n            \"type\": \"collection\",\n            \"entry\": [\n            {\n                \"resource\": {\n                \"resourceType\": \"Patient\",\n                \"id\": \"Patient1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Alice\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Encounter\",\n                \"id\": \"Encounter1\",\n                \"status\": \"in-progress\",\n                \"class\": {\n                    \"code\": \"AMB\",\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"participant\": [\n                    {\n                    \"individual\": {\n                        \"reference\": \"Practitioner/Practitioner1\"\n                    }\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Practitioner\",\n                \"id\": \"Practitioner1\",\n                \"name\": [\n                    {\n                    \"given\": [\n                        \"Michael\"\n                    ]\n                    }\n                ]\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"MedicationRequest\",\n                \"id\": \"PastMedicationRequest\",\n                \"status\": \"active\",\n                \"intent\": \"order\",\n                \"authoredOn\": \"2023-01-01\",\n                \"medicationCodeableConcept\": {\n                    \"text\": \"Some medication\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"CurrentMedication\",\n                \"status\": \"active\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Medication\",\n                \"id\": \"PastMedication\",\n                \"form\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"pill\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Pill\"\n                    }\n                    ]\n                },\n                \"status\": \"inactive\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"DetectedIssue\",\n                \"id\": \"DetectedIssue1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"TIME\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActCode\",\n                        \"display\": \"Time-related Detected Issue\"\n                    }\n                    ]\n                },\n                \"severity\": \"high\",\n                \"patient\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"identifiedDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Condition\",\n                \"id\": \"Condition1\",\n                \"clinicalStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"active\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-clinical\"\n                    }\n                    ]\n                },\n                \"verificationStatus\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"provisional\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-ver-status\"\n                    }\n                    ]\n                },\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"problem-list-item\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/condition-category\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"422504002\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Ischemic stroke (disorder)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"recordedDate\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"Inference1\",\n                \"status\": \"final\",\n                \"code\": {\n                    \"text\": \"Inference\",\n                    \"coding\": [\n                    {\n                        \"code\": \"448765001\",\n                        \"system\": \"http://snomed.info/sct\",\n                        \"display\": \"Unintentional weight loss (finding)\"\n                    }\n                    ]\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"effectiveDateTime\": \"2023-01-01\"\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Flag\",\n                \"id\": \"Flag1\",\n                \"status\": \"active\",\n                \"category\": [\n                    {\n                    \"coding\": [\n                        {\n                        \"code\": \"admin\",\n                        \"system\": \"http://terminology.hl7.org/CodeSystem/flag-category\",\n                        \"display\": \"Administrative\"\n                        }\n                    ]\n                    }\n                ],\n                \"code\": {\n                    \"text\": \"Flag\"\n                },\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"period\": {\n                    \"start\": \"2023-01-01\",\n                    \"end\": \"2024-01-01\"\n                }\n                }\n            },\n            {\n                \"resource\": {\n                \"resourceType\": \"Observation\",\n                \"id\": \"ActiveRaTreatmentFeature1\",\n                \"meta\": {\n                    \"profile\": [\n                    \"http://example.org/StructureDefinition/ActiveRaTreatmentFeature\"\n                    ]\n                },\n                \"status\": \"final\",\n                \"code\": {\n                    \"coding\": [\n                    {\n                        \"code\": \"on-ra-treatment\",\n                        \"system\": \"http://example.org/CodeSystem/CaseFeatureCodes\"\n                    }\n                    ]\n                },\n                \"derivedFrom\": [\n                    {\n                    \"reference\": \"QuestionnaireResponse/RaQuestionnaireResponse3\"\n                    }\n                ],\n                \"subject\": {\n                    \"reference\": \"Patient/Patient1\"\n                },\n                \"valueBoolean\": true\n                }\n            }\n            ]\n        }\n        },\n        {\n            \"name\": \"contentEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{contentEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"content\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{contentEndpointType}}\"\n                }\n            }\n        },\n        {\n            \"name\": \"terminologyEndpoint\",\n            \"resource\": {\n                \"resourceType\": \"Endpoint\",\n                \"address\": \"{{terminologyEndpointAddress}}\",\n                \"status\": \"active\",\n                \"payloadType\": [\n                    {\n                        \"coding\": [\n                            {\n                                \"code\": \"terminology\"\n                            }\n                        ]\n                    }\n                ],\n                \"connectionType\": {\n                    \"code\": \"{{terminologyEndpointType}}\"\n                }\n            }\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{cpgServer}}/PlanDefinition/$apply",
					"host": [
						"{{cpgServer}}"
					],
					"path": [
						"PlanDefinition",
						"$apply"
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"const lodash = require('lodash')",
					"/**",
					" * Delete the id and text as this can vary per request",
					" */",
					"Object.prototype.testPrepare = function testPrepare(resource) {",
					"  delete resource.id;",
					"  delete resource.text;",
					"  ",
					"  resource.entry.forEach(e => {",
					"    delete e.fullUrl;",
					"    delete e.resource.id;",
					"    e.resource.meta ? delete e.resource.meta : null",
					"    if (e.resource.extension) {",
					"      e.resource.extension.forEach(ext => {",
					"        ext.valueReference ? delete ext.valueReference.reference : null",
					"      })",
					"    }",
					"    if (e.resource.action) {",
					"      e.resource.action.forEach(a => {",
					"        a.resource ? delete a.resource.reference : null",
					"        if (a.action) {",
					"          a.action.forEach(subA => {",
					"            subA.resource ? delete subA.resource.reference : null",
					"          })",
					"        }",
					"      })",
					"    }",
					"  })",
					"  return resource;",
					"}",
					"",
					"function clearEmpties(el) {",
					"  function internalClean(el) {",
					"    return lodash.transform(el, function(result, value, key) {",
					"      var isCollection = lodash.isObject(value);",
					"      var cleaned = isCollection ? internalClean(value) : value;",
					"      if (isCollection && lodash.isEmpty(cleaned)) {",
					"        return;",
					"      }",
					"      lodash.isArray(result) ? result.push(cleaned) : (result[key] = cleaned);",
					"    });",
					"  }",
					"  return lodash.isObject(el) ? internalClean(el) : el;",
					"}",
					"",
					"/**",
					" * Find difference between two objects",
					" * @param  {object} origObj - Source object to compare newObj against",
					" * @param  {object} newObj  - New object with potential changes",
					" * @return {object} differences",
					" */",
					"function difference(origObj, newObj) {",
					"  function changes(newObj, origObj) {",
					"    let arrayIndexCounter = 0",
					"    return lodash.transform(newObj, function (result, value, key) {",
					"      if (!lodash.isEqual(value, origObj[key])) {",
					"        let resultKey = lodash.isArray(origObj) ? arrayIndexCounter++ : key",
					"        result[resultKey] = ",
					"            (lodash.isObject(value) && lodash.isObject(origObj[key])) ",
					"                ? changes(value, origObj[key]) : value",
					"      }",
					"    })",
					"  }",
					"  return changes(newObj, origObj)",
					"}",
					"/**",
					" * @param {object} Object to sort",
					" * @return {object} Object with sorted entries",
					" */",
					"  function sortEntries(obj) {",
					"    const entry = (obj.entry?.sort((a, b) => {",
					"      if (a.resource?.instantiatesCanonical != null && b.resource?.instantiatesCanonical != null) {",
					"        if (b.resource.instantiatesCanonical[0] > a.resource.instantiatesCanonical[0]) {",
					"          return -1",
					"        }",
					"        if (a.resource.instantiatesCanonical[0] > b.resource.instantiatesCanonical[0]) {",
					"          return 1",
					"        }",
					"      }",
					"      if (a.resource?.resourceType != null && b.resource?.resourceType != null) {",
					"        if (b.resource.resourceType > a.resource.resourceType) {",
					"          return -1",
					"        }",
					"        if (a.resource.resourceType > b.resource.resourceType) {",
					"          return 1",
					"        }",
					"      }",
					"      return 0",
					"    }))",
					"    return {",
					"      ...obj,",
					"      entry",
					"    }",
					"  }",
					"",
					"/**",
					" * Does a deep equal comparison, uses console.log to show diffs if fails.",
					" * ",
					" * @example",
					" * pm.test(\"My test\", function() {",
					" *   lodash.expectToDeepEqual(pm.response.json(), expected, console);",
					" * });",
					" */",
					"Object.prototype.expectToDeepEqual = (actual, expected, console = console) => {",
					"    const actualSorted = sortEntries(actual)",
					"    const expectedSorted = sortEntries(expected)",
					"  try {",
					"    pm.expect(lodash.testPrepare(actualSorted)).to.deep.equal(lodash.testPrepare(expectedSorted));",
					"  } catch (e) {",
					"    try {",
					"        const diff1 = clearEmpties(difference(e.actual, e.expected, lodash.isNil));",
					"        const diff2 = clearEmpties(difference(e.expected, e.actual, lodash.isNil));",
					"        console.log('missing from actual:', diff1);",
					"        console.log('extraneous (found in actual but not expected):', diff2);",
					"        console.log({ actual: e.actual, expected: e.expected});",
					"    } catch(ee) {",
					"        console.log(\"Error\", ee)",
					"    }",
					"    e.message = `*** See Console *** ${e.message}`;",
					"    throw new Error(e);",
					"  }",
					"}"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "cpgServer",
			"value": "http://localhost:9001",
			"type": "string"
		},
		{
			"key": "contentEndpointAddress",
			"value": "file:///Users/taylorkingston/projects/pd-apply/connectathon/output",
			"type": "string"
		},
		{
			"key": "contentEndpointType",
			"value": "hl7-fhir-file",
			"type": "string"
		},
		{
			"key": "terminologyEndpointAddress",
			"value": "file:///Users/taylorkingston/projects/pd-apply/connectathon/output",
			"type": "string"
		},
		{
			"key": "terminologyEndpointType",
			"value": "hl7-fhir-file",
			"type": "string"
		}
	]
}